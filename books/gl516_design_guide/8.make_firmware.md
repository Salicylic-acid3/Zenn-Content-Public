---
title: "🖥QMKファームウェアを作成する"
---
# ０．本チャプターのゴール

本チャプターが完了するとキーボードを実際に動かすためのファームウェアと、VIA/Remapで動作するJSONファイルが出来上がります。
![](/images/gl516design/8-11_template-8.png)
GL516はファームウェアもテンプレート化しているので、プログラミング初心者でも比較的簡単にファームウェアを作り上げることができます。

# １．QMK環境を構築する

何はなくともまずはQMK Firmwareの環境を構築しましょう。
環境構築後をすることでファームウェアをコンパイルしてProMicroに書き込むことができます。

QMK環境の構築はQMK Firmwareの公式ドキュメントを参照して構築をしてみてください。
https://docs.qmk.fm/#/newbs_getting_started
:::message
本当はQMK環境の構築も詳細に書きたかったのですが、QMK Firmwareは環境構築手順が頻繁に変わるのが特徴の一つです。
今の構築手順を詳しく書いてしまうと情報が古くなったときに読者に不利益を与えてしまう可能性があるため、ここでは公式ドキュメントを紹介するにとどめています。
何卒ご了承ください。
:::

# ２．確認のためにコンパイルしてみる

- 環境が構築できたらまずコンパイルできるか確認する。
`make 7skb:default`
※マージされているキーボードなら何でも大丈夫です。
　GL516の作例については現在マージ中です。
QMK MSYSを使用している場合は以下も試してみる。
`qmk compile -kb gl516/a52gl -km default`
最終的に` * The firmware size is fine`が出力されれば環境は正常に構築できている。
![](/images/gl516design/8-1_testcompile-1.png)

# ３．テンプレートをダウンロードして配置する

- テンプレートファームウェアをダウンロードする
https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/samples/gl516design/template.zip
![](/images/gl516design/8-2_template-1.png)

- ダウンロードしたファームウェアは展開してQMKファームウェアを配置したディレクトリの`qmk_firmware/keyboards/gl516`配下に配置してください。
![](/images/gl516design/8-3_template-2.png)

# ４．リネームする

`template`という名前のままではアガらないので、キーボード名を自分のものに変更しましょう。
- フォルダ名を変更する。
![](/images/gl516design/8-4_template-3.png)
:::message
キーボードの名前は全て小文字で、アルファベット、数字、アンダースコア(_)のみで構成する必要があります。
また、アンダースコア(_)をキーボード名の頭につけることはできません。
:::

- `template.c`と`template.h`のファイル名を変更する。
![](/images/gl516design/8-5_template-4.png)
:::message
フォルダ名と同じにする必要があります。
:::

- 元`template.c`の中のファイル名を変更する。
```diff c:元template.c
-   #include "template.h"
+   #include "yatteiki.h"
```

# ５．config.hを編集する

`config.h`はその名の通り、キーボードの基本的な設定を記載します。
- USB機器としての情報を変更する。
```c:config.h
#define VENDOR_ID       0xF516   //GL516をもじっただけ。正規に取得して変更してもよい。
#define PRODUCT_ID      0xF516   //任意の値に変更。できるだけ他のキーボードとかぶらないように名前をもじったり工夫しておく。
#define DEVICE_VER      0x0001
#define MANUFACTURER    Salicylic_Acid   //任意の値に変更。
#define PRODUCT         template   //任意の値に変更
```

- キーマトリクスのサイズを変更する。
```c:config.h
/* key matrix size */
#define MATRIX_ROWS 10   //MATRIX_ROW_PINSの倍数。行数を減らした場合は減らす。
#define MATRIX_COLS 8   //MATRIX_COL_PINSの数。列数を減らした場合は減らす。

// wiring of each half
#define MATRIX_ROW_PINS { D1, D0, D4, C6, D7 }   //行数を減らした場合は右から減らす。
#define MATRIX_COL_PINS { F4, F5, F6, F7, B1, B3, B2, E6 }   //列数を減らした場合は右から減らす。
#define UNUSED_PINS
```

- LEDの設定を変更する。
```c:config.h
/* ws2812 RGB LED */
#define RGB_DI_PIN D3   //LEDを使用しない場合はこの行も含めて全て削除。

#ifndef RGBLED_NUM
  #define RGBLED_NUM 80   //LEDの数。任意の値に変更。
#endif
```

# ６．元template.hを編集する

元template.hというファイルにはレイアウトマクロが定義されています。
これはキーマトリクスを用いた行列のどのキーが有効で、どういう配置でキーが並んでいるのかを定義しています。
以下はキーマトリクスを用いた行列のどのキーが有効かを定義しています。
```c:config.h（template）
#define LAYOUT( \
～～～～～～～～省略～～～～～～～～
  ) \
  { \
    { L00,   L01,   L02,   L03,   L04,   L05,   L06,   L07 }, \
    { L10,   L11,   L12,   L13,   L14,   L15,   L16,   L17 }, \
    { L20,   L21,   L22,   L23,   L24,   L25,   L26,   L27 }, \
    { L30,   L31,   L32,   L33,   L34,   L35,   L36,   L37 }, \
    { L40,   L41,   L42,   L43,   L44,   L45,   L46,   L47 }, \
    { R00,   R01,   R02,   R03,   R04,   R05,   R06,   R07 }, \
    { R10,   R11,   R12,   R13,   R14,   R15,   R16,   R17 }, \
    { R20,   R21,   R22,   R23,   R24,   R25,   R26,   R27 }, \
    { R30,   R31,   R32,   R33,   R34,   R35,   R36,   R37 }, \
    { R40,   R41,   R42,   R43,   R44,   R45,   R46,   R47 }  \
  }
```
つまり、設計工程で回路図から削除したキーの部分に`KC_NO`を入れる必要があります。
![](/images/gl516design/8-6_layout-1.png)
![](/images/gl516design/8-7_layout-2.png)
:::message
a52glは1行と1列を削除したために7x8 (7x4x2)の行列となっています。
:::

以下は行列で定義されたスイッチが、どのような順番に並んでいるのかを定義しています。
これは基板と見比べながら書いていきます。
```c:config.h（template）
#define LAYOUT( \
    L00, L01, L02, L03, L04, L05, L06, L07, R00, R01, R02, R03, R04, R05, R06, R07, \
    L10, L11, L12, L13, L14, L15, L16, L17, R10, R11, R12, R13, R14, R15, R16, R17, \
    L20, L21, L22, L23, L24, L25, L26, L27, R20, R21, R22, R23, R24, R25, R26, R27, \
    L30, L31, L32, L33, L34, L35, L36, L37, R30, R31, R32, R33, R34, R35, R36, R37, \
    L40, L41, L42, L43, L44, L45, L46, L47, R40, R41, R42, R43, R44, R45, R46, R47  \
  ) \
  { \
～～～～～～～～省略～～～～～～～～
  }
```
```c:config.h（template）
#define LAYOUT( \
    L00, L01, L02, L03, L04, L05,    L06, R00, R01, R02, R03, R04, R05, R06, \
    L10, L11, L12, L13, L14, L15,    L16, R10, R11, R12, R13, R14, R15,      \
    L20, L21, L22, L23, L24, L25,    L26, R20, R21, R22, R23, R24, R25, R26, \
    L30, L31, L32,   L34,    L35,      L36,    R31,      R33, R34, R35, R36  \
  ) \
  { \
～～～～～～～～省略～～～～～～～～
  }
```

- 以上の解説を踏まえてレイアウトマクロを変更する。

```c:config.h（a52gl）
#define LAYOUT( \
    L00, L01, L02, L03, L04, L05,    L06, R00, R01, R02, R03, R04, R05, R06, \
    L10, L11, L12, L13, L14, L15,    L16, R10, R11, R12, R13, R14, R15,      \
    L20, L21, L22, L23, L24, L25,    L26, R20, R21, R22, R23, R24, R25, R26, \
    L30, L31, L32,   L34,    L35,      L36,    R31,      R33, R34, R35, R36  \
  ) \
  { \
    {   L00,   L01,   L02,   L03,   L04,   L05,   L06 }, \
    {   L10,   L11,   L12,   L13,   L14,   L15,   L16 }, \
    {   L20,   L21,   L22,   L23,   L24,   L25,   L26 }, \
    {   L30,   L31,   L32, KC_NO,   L34,   L35,   L36 }, \
    {   R00,   R01,   R02,   R03,   R04,   R05,   R06 }, \
    {   R10,   R11,   R12,   R13,   R14,   R15, KC_NO }, \
    {   R20,   R21,   R22,   R23,   R24,   R25,   R26 }, \
    { KC_NO,   R31, KC_NO,   R33,   R34,   R35,   R36 }  \
  }
```

# ７．キーマップを編集する

- defaultキーマップを作成する。
QMK公式ドキュメントの[キーコード一覧](https://docs.qmk.fm/#/keycodes)を参照し、keymaps/defaultフォルダ配下の`keymap.c`を編集する。
```c:keymap.c（template/keymaps/default）
  [0] = LAYOUT(
  //,-----------------------------------------------------------------------------------------------------------------------------------------------.
       KC_ESC,    KC_1,    KC_2,    KC_3,    KC_4,    KC_5, KC_PSLS, KC_PAST, KC_PMNS,    KC_6,    KC_7,    KC_8,    KC_9,    KC_0, KC_MINS,  KC_EQL,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
       KC_TAB,    KC_Q,    KC_W,    KC_E,    KC_R,    KC_T,   KC_P7,   KC_P8,   KC_P9,    KC_Y,    KC_U,    KC_I,    KC_O,    KC_P, KC_LBRC, KC_RBRC,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      KC_CAPS,    KC_A,    KC_S,    KC_D,    KC_F,    KC_G,   KC_P4,   KC_P5,   KC_P6,    KC_H,    KC_J,    KC_K,    KC_L, KC_SCLN, KC_QUOT,  KC_ENT,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      KC_LSFT,    KC_Z,    KC_X,    KC_C,    KC_V,    KC_B,   KC_P1,   KC_P2,   KC_P3,    KC_N,    KC_M, KC_COMM,  KC_DOT, KC_SLSH,   KC_UP, KC_RSFT,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
     KC_LCTRL, KC_LGUI, KC_LALT,  KC_ENT,  KC_SPC, KC_BSPC,   KC_P0, KC_PDOT, KC_PPLS,  KC_DEL,  KC_SPC, KC_RALT,  KC_APP, KC_LEFT, KC_DOWN, KC_RGHT
  //|-----------------------------------------------------------------------------------------------------------------------------------------------'
  )
```
:::message
defaultキーマップはLEDインジケータ機能やOLED機能などを付けずにシンプルにまとめてください。
正直、コンパイルテスト以降で使用することは少ないと思います。
:::

  - defaultキーマップをコンパイルする。
`make gl516/template:default`
QMK MSYSを使用している場合は以下も試してみる。
`qmk compile -kb gl516/template -km default`
:::message
コンパイルが通ってから次に進みましょう。
via用のキーマップを作ってから修正点が見つかると、defaultキーマップも同様に直す必要があり、手間やミスの元です。
:::

- VIAキーマップを作成する。
:::message
[VIA](https://caniuseVIA.com/)や[Remap](https://remap-keys.app/)というツールを使うことでキーボードのリセットやファームウェアの作成なしで、ダイナミックにキーマップを変更できます。
是非VIA用のキーマップ、VIA用のJSONファイルを作成してください。
:::
defaultキーマップをVIA用のキーマップに上書きする。
```c:keymap.c（template/keymaps/via）
  [0] = LAYOUT(
  //,-----------------------------------------------------------------------------------------------------------------------------------------------.
       KC_ESC,    KC_1,    KC_2,    KC_3,    KC_4,    KC_5, KC_PSLS, KC_PAST, KC_PMNS,    KC_6,    KC_7,    KC_8,    KC_9,    KC_0, KC_MINS,  KC_EQL,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
       KC_TAB,    KC_Q,    KC_W,    KC_E,    KC_R,    KC_T,   KC_P7,   KC_P8,   KC_P9,    KC_Y,    KC_U,    KC_I,    KC_O,    KC_P, KC_LBRC, KC_RBRC,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      KC_CAPS,    KC_A,    KC_S,    KC_D,    KC_F,    KC_G,   KC_P4,   KC_P5,   KC_P6,    KC_H,    KC_J,    KC_K,    KC_L, KC_SCLN, KC_QUOT,  KC_ENT,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      KC_LSFT,    KC_Z,    KC_X,    KC_C,    KC_V,    KC_B,   KC_P1,   KC_P2,   KC_P3,    KC_N,    KC_M, KC_COMM,  KC_DOT, KC_SLSH,   KC_UP, KC_RSFT,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
     KC_LCTRL, KC_LGUI, KC_LALT,  KC_ENT,  KC_SPC, KC_BSPC,   KC_P0, KC_PDOT, KC_PPLS,  KC_DEL,  KC_SPC, KC_RALT,  KC_APP, KC_LEFT, KC_DOWN, KC_RGHT
  //|-----------------------------------------------------------------------------------------------------------------------------------------------'
  ),    ←ここのカンマを忘れずに！！
```
:::message alert
VIA用のキーマップはdefaultレイヤーを含めてレイヤーが4つ必要です。
defaultキーマップはレイヤーがdefaultのみなので最後のカンマは不要でしたが、VIA用のキーマップのdefaultレイヤーの最後にはカンマが必要ですので忘れずに付けましょう。
:::
VIA用のキーマップにはレイヤーが4つ必要なので、defaultレイヤー以外も作る。
:::message
defaultレイヤー以外は`_______`で埋めても大丈夫です。
:::
```c:keymap.c（template/keymaps/via）
  [1] = LAYOUT(
  //,-----------------------------------------------------------------------------------------------------------------------------------------------.
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
  //|-----------------------------------------------------------------------------------------------------------------------------------------------'
  ),
  ～～～～～～～～省略～～～～～～～～
  [3] = LAYOUT(
  //,-----------------------------------------------------------------------------------------------------------------------------------------------.
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  //|--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------|
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
  //|-----------------------------------------------------------------------------------------------------------------------------------------------'
  )    ←ここのカンマは不要！！
```
:::details Tips:LEDによるレイヤーインジケータ機能について
この手の付加機能はdefaultキーマップに追加することはオススメしませんが、VIA用のキーマップには追加しておいてもいいと思います。
```c:keymap.c（template/keymaps/via）
//A description for expressing the layer position in LED mode.
layer_state_t layer_state_set_user(layer_state_t state) {
#ifdef RGBLIGHT_ENABLE
    switch (get_highest_layer(state)) {
    case 1:
      rgblight_sethsv_at(HSV_BLUE, 0);    //色を変えるにはHSV_BLUEなどの所を編集してください。
      break;
    case 2:
      rgblight_sethsv_at(HSV_RED, 0);
      break;
    case 3:
      rgblight_sethsv_at(HSV_PURPLE, 0);
      break;
    default: //  for any other layers, or the default layer
      rgblight_sethsv_at( 0, 0, 0, 0);    //defaultレイヤーでは光らないようにしていますが、defaultレイヤーでも光らせたい場合は上と同じ様に入力してください。
      break;
    }
    rgblight_set_effect_range( 1, 79);    //レイヤーインジケータ機能にLEDを何個使用したいか、残り何個は普通に光らせたいかを記述します。この例の場合、1個目だけをインジケータに用い、残り79個は普通に光ります。
#endif
return state;
}
```
:::
  - VIA用キーマップをコンパイルする。
`make gl516/template:via`
QMK MSYSを使用している場合は以下も試してみる。
`qmk compile -kb gl516/template -km via`

# ８．VIA用JSONファイルを作成する

こちらの記事を参照してください。
https://salicylic-acid3.hatenablog.com/entry/via-support
GL516作例のKLEのリンクとJSONファイルも書いておきますので、参考にしてください。
| キーボード名 | KLE | JSON |
| ---- | ---- | ---- |
| template | [こちら](http://www.keyboard-layout-editor.com/#/gists/31300ff2bad210db40524818077b33e9f) | [こちら](https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/gl516design/samples/template.json) |
| A52GL | [こちら](http://www.keyboard-layout-editor.com/#/gists/906e8e12719b0afbb8c49acf99f83d8a) | [こちら](https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/gl516design/samples/a52gl.json) |
| J73GL | [こちら](http://www.keyboard-layout-editor.com/#/gists/39965bf9ba71cfa908874b1dc6023d69) | [こちら](https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/gl516design/samples/j73gl.json) |
| N51GL | [こちら](http://www.keyboard-layout-editor.com/#/gists/6145324e474be196558a399c74e4eaaf) | [こちら](https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/gl516design/samples/n51gl.json) |

# 別解．QMK環境も入れたくないしコンパイルなんてしたくない、という方へ

上記の通り、テンプレートファームウェアから削除して専用のファームウェアを作成するので、どうしてもファームウェアの作成が難しい方はテンプレートファームウェアをそのまま使用しても使えます。
templateのファームウェアをそのまま使うと反応しないキーが存在してしまいますので、VIA用のJSONファイルを少しだけ修正して使うことで遜色なく使うことができます。
VIA用ファームウェアのHexファイルは[こちら](https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/gl516design/samples/gl516_template_via.hex)。
VIA用ファームウェアのJSONファイルは[こちら](https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/gl516design/samples/template.json)。

- KLEにて不要なキーを削除、またはレイアウトを変更。
![](/images/gl516design/8-8_template-5.png)

- jsonファイルをダウンロードする。
![](/images/gl516design/8-9_template-6.png)

- ダウンロードしたjsonファイルの一部をコピー
```json:template.json（KLEからダウンロードしたファイル）
[
  {
    "name": "template"
  },
  [      //←ここから
    "0,0",
    "0,1",
    "0,2",
    "0,3",
    "0,4",
    "0,5",
    {
      "x": 3
    },
    "5,1",
    "5,2",
    "5,3",
    "5,4",
    "5,5",
    "5,6",
    "5,7"
  ],
～～～～～～～～省略～～～～～～～～
  [
    "4,0",
    "4,1",
    "4,2",
    "4,3",
    "4,4",
    "4,5",
    {
      "x": 3
    },
    "9,1",
    "9,2",
    "9,3",
    "9,4",
    "9,5",
    "9,6",
    "9,7"
  ]      //←ここまでをコピー
]
```
- templateファームウェア用の[JSONファイル](https://github.com/Salicylic-acid3/Zenn-Content-Public/blob/main/gl516design/samples/template.json)にペーストする。

```json:template.json（著者のリポジトリからダウンロードしたファイル）
{
    "name": "template",
    "vendorId": "0xF516",
    "productId": "0xF516",
    "lighting": "qmk_rgblight",
    "matrix": { "rows": 10, "cols": 8 },
    "layouts": {
        "keymap": [
            [      //←ここから
                "0,0",
                "0,1",
                "0,2",
                "0,3",
                "0,4",
                "0,5",
                "0,6",
                "0,7",
                "5,0",
                "5,1",
                "5,2",
                "5,3",
                "5,4",
                "5,5",
                "5,6",
                "5,7"
            ],
～～～～～～～～省略～～～～～～～～
            [
                "4,0",
                "4,1",
                "4,2",
                "4,3",
                "4,4",
                "4,5",
                "4,6",
                "4,7",
                "9,0",
                "9,1",
                "9,2",
                "9,3",
                "9,4",
                "9,5",
                "9,6",
                "9,7"
            ]      //←ここまでを置き換える
        ]
    }
}
```
- これをRemapやVIAで読み込ませることでファームウェアなどを一切書かずに作ったレイアウトでキーボードを使用できる。
![](/images/gl516design/8-10_template-7.png)
![](/images/gl516design/8-11_template-8.png)

:::message alert
別解の手順で作成したJSONファイルのRemapへの登録はお控えください。
VID/PID/キーボード名のすべてが同一であると判定され、他のtemplateファームウェアの使用者が困ってしまいます。
:::
